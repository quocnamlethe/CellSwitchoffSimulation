% Wait bar
hwait = waitbar(0,'Calculating');

% Initialize the model parameters
ModelParameters = ModelParaSet();
ModelParameters.lambda = 100e-6;          

% Initialize the test set
testNum = 5;
CsoTest = CsoTestSet(testNum);
Cov = zeros(1,10);
CovAvg = zeros(1,5);

% Initialize Users
 UsersIn=10000;
 User_ModlPrmtrs=ModelParaSet();        
 User_ModlPrmtrs.lambda=UsersIn*10^-6;
 BS_ModlPrmtrs.alpha_norm=2;
 [User_Locations]=UT_LatticeBased('hexUni', User_ModlPrmtrs);
 
% Initialize Channel
 Exponent = 4; %pathloss Exponent
 Shadow = 6; % [dB]  % Log-distance or Log-normal shadowing
 
 SIRMericType='MedianSIR';

warning off;
for l = 1:5
    % Test for incrementing perturbation values
    ModelParameters.alpha_norm = 0.25 * l - 0.25;
    CsoTest.ModelParameters = ModelParameters;
    
    % Initialize the testPlot structure for each test method
    for k = 1:testNum
        testPlot = CsoTest.TestBs(k).TestPlot;
        testPlot = [testPlot, TestPlotSet(num2str(ModelParameters.alpha_norm))];
        CsoTest.TestBs(k).TestPlot = testPlot;
    end
    
    % Test 10 times per switch off percentage
    for j = 1:10        
        % Generate base station locations
        [InitialBs]= UT_LatticeBased('hexUni' , ModelParameters);

        % Set up the initial base station locations and CoVs
        CsoTest.InitialBs.ActiveBs = InitialBs;
        [CN, CV, CD] = CoV_Metrics(CsoTest.InitialBs.ActiveBs, ModelParameters);
        CsoTest.InitialBs.CN = CN;
        CsoTest.InitialBs.CV = CV;
        CsoTest.InitialBs.CD = CD;
        
        % Get current CD value
        Cov(j) = CD;

        % Test each switch off percentage
        for m = 0:9
            % TODO Fix wait bar to match new values
            waitbar(((l - 1)*10*10 + (j - 1)*10 + m)/(5*10*10),hwait);
            
            % Variable switch off percentage
            percentSO = 0.1 * m;

            % Initialize the test structures
            for k = 1:testNum
                CsoTest.TestBs(k).ActiveBs = InitialBs;
                CsoTest.TestBs(k).InactiveBs = [];
            end

            % Run SO algorithms on the base station locations
            if percentSO > 0
                CsoTest.TestBs(1) = AverageNearestSO(CsoTest.TestBs(1),percentSO,1);
                CsoTest.TestBs(2) = AverageNearestSO(CsoTest.TestBs(2),percentSO,2);
                CsoTest.TestBs(3) = NumNearestSO(CsoTest.TestBs(3),percentSO);
                CsoTest.TestBs(4) = MinVoronoiSO(CsoTest.TestBs(4),percentSO,ModelParameters);
                CsoTest.TestBs(5) = MaxRegSo(CsoTest.TestBs(5),percentSO,ModelParameters);
            end
                
            % Calculate the CoVs and input them into the test plot
            % structures
            for k = 1:testNum
                [CN, CV, CD] = CoV_Metrics(CsoTest.TestBs(k).ActiveBs, ModelParameters);
                CsoTest.TestBs(k).CN = CN;
                CsoTest.TestBs(k).CV = CV;
                CsoTest.TestBs(k).CD = CD;
                
                [SIR_dB] = SIR_RayleighCh2(soTest.TestBs(k).ActiveBs,User_Locations,Exponent,Shadow,SIRMericType);
                
                SIR = 
                CnData = CsoTest.TestBs(k).TestPlot(l).CnData;
                CnData = [CnData ; percentSO, CN];
                CsoTest.TestBs(k).TestPlot(l).CnData = CnData;
                
                CvData = CsoTest.TestBs(k).TestPlot(l).CvData;
                CvData = [CvData ; percentSO, CV];
                CsoTest.TestBs(k).TestPlot(l).CvData = CvData;
                
                CdData = CsoTest.TestBs(k).TestPlot(l).CdData;
                CdData = [CdData ; percentSO, CD];
                CsoTest.TestBs(k).TestPlot(l).CdData = CdData;
            end
        end
    end
    
    % Get the median of tested input CoVs
    CovAvg(l) = mean(Cov);
    CsoTest.TestBs(k).TestPlot(l).Tag = num2str(CovAvg(l));
end
warning on;

save('data/Test_SOvsSIRdiffData.mat', 'CsoTest');
close(hwait);
